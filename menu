#!/bin/bash
# =============================================
# SSLABLk VPS Manager v2.1 - Full Menu
# Supports: SSH WS, Trojan WS, UDP Custom
# Manual Password + IP Limit
# =============================================

UDPDIR="/root/udp"
USERFILE="$UDPDIR/users.txt"
EXPIRE_FILE="/etc/expire_users.txt"
LIMIT_FILE="/etc/Sslablk/limits.txt"
mkdir -p $UDPDIR /etc/Sslablk

clear
echo "============================================" | lolcat 2>/dev/null || echo "============================================"
echo "         SSLABLk VPS MANAGER v2.1"          | lolcat 2>/dev/null || echo "         SSLABLk VPS MANAGER v2.1"
echo "============================================" | lolcat 2>/dev/null || echo "============================================"
echo ""
echo "1.  Create SSH WebSocket"
echo "2.  Create Trojan WebSocket"
echo "3.  Create UDP User"
echo "4.  Delete User"
echo "5.  List UDP Users"
echo "6.  Check Active UDP Sessions"
echo "7.  Restart All Services"
echo "8.  Change Ports (UDP/WS)"
echo "9.  VPS Speedtest"
echo "10. Backup / Restore Users"
echo "11. System Info"
echo "12. Exit"
echo "13. Set IP Limit Manual"
echo ""
read -p "Select menu [1-13]: " opt

case $opt in

# ----------------------------
# 1. Create SSH WebSocket
# ----------------------------
1)
clear
echo "üöÄ Create SSH WebSocket Account"
read -p "Username : " user
read -s -p "Password : " pass; echo
read -p "Active days : " days
useradd -e $(date -d "$days days" +"%Y-%m-%d") -m -s /bin/bash "$user" 2>/dev/null || true
echo "${user}:${pass}" | chpasswd 2>/dev/null || true
exp=$(date -d "$days days" +"%Y-%m-%d")
echo "$user $exp" >> $EXPIRE_FILE

read -p "Add IP limit? (y/N): " want_limit
if [[ "$want_limit" =~ ^[Yy]$ ]]; then
  read -p "Source IP (leave empty = all IPs): " srcip
  read -p "Max TCP conn per IP WS (80/443) [default 10]: " max_tcp
  max_tcp=${max_tcp:-10}
  if [[ -n "$srcip" ]]; then
    iptables -I INPUT -p tcp -s "$srcip" --dport 443 -m connlimit --connlimit-above "$max_tcp" --connlimit-mask 32 -j REJECT --reject-with tcp-reset
    iptables -I INPUT -p tcp -s "$srcip" --dport 80 -m connlimit --connlimit-above "$max_tcp" --connlimit-mask 32 -j REJECT --reject-with tcp-reset
    tcp_rule="tcp-src:${srcip}-dport:80,443-max:${max_tcp}"
  else
    iptables -I INPUT -p tcp --dport 443 -m connlimit --connlimit-above "$max_tcp" --connlimit-mask 32 -j REJECT --reject-with tcp-reset
    iptables -I INPUT -p tcp --dport 80 -m connlimit --connlimit-above "$max_tcp" --connlimit-mask 32 -j REJECT --reject-with tcp-reset
    tcp_rule="tcp-all-dport:80,443-max:${max_tcp}"
  fi
  echo "$user|$tcp_rule|" >> $LIMIT_FILE
  iptables-save >/etc/iptables.up.rules
fi
echo "‚úÖ SSH-WS created: $user (exp: $exp)"
read -p "ENTER to continue..."
exec /usr/local/bin/menu
;;

# ----------------------------
# 2. Create Trojan WS
# ----------------------------
2)
clear
echo "‚ö° Create Trojan WebSocket Account"
read -p "Label (username) : " user
read -p "Active days : " days
uuid=$(cat /proc/sys/kernel/random/uuid)
exp=$(date -d "$days days" +"%Y-%m-%d")
echo "$user $uuid $exp" >> /etc/trojan_users.txt
echo "$user $exp" >> $EXPIRE_FILE

read -p "Add IP limit? (y/N): " want_limit
if [[ "$want_limit" =~ ^[Yy]$ ]]; then
  read -p "Source IP (leave empty = all IPs): " srcip
  read -p "Max TCP conn per IP Trojan (443) [default 5]: " max_tcp
  max_tcp=${max_tcp:-5}
  if [[ -n "$srcip" ]]; then
    iptables -I INPUT -p tcp -s "$srcip" --dport 443 -m connlimit --connlimit-above "$max_tcp" --connlimit-mask 32 -j REJECT --reject-with tcp-reset
    tcp_rule="tcp-src:${srcip}-dport:443-max:${max_tcp}"
  else
    iptables -I INPUT -p tcp --dport 443 -m connlimit --connlimit-above "$max_tcp" --connlimit-mask 32 -j REJECT --reject-with tcp-reset
    tcp_rule="tcp-all-dport:443-max:${max_tcp}"
  fi
  echo "$user|$tcp_rule|" >> $LIMIT_FILE
  iptables-save >/etc/iptables.up.rules
fi
echo "‚úÖ Trojan-WS created: $user (UUID: $uuid, exp: $exp)"
read -p "ENTER to continue..."
exec /usr/local/bin/menu
;;

# ----------------------------
# 3. Create UDP User
# ----------------------------
3)
clear
echo "‚ûï Create UDP User"
read -p "Username : " user
read -s -p "Password : " pass; echo
read -p "Active days : " days
exp=$(date -d "$days days" +"%Y-%m-%d")
echo "$user:$pass:$exp" >> $UDPDIR/users.txt
echo "$user $exp" >> $EXPIRE_FILE

read -p "Add IP limit? (y/N): " want_limit
if [[ "$want_limit" =~ ^[Yy]$ ]]; then
  read -p "Source IP (leave empty = all IPs): " srcip
  read -p "Max UDP packets/sec per IP (7300) [default 20]: " max_udp
  max_udp=${max_udp:-20}
  read -p "UDP burst allowance [default 40]: " udp_burst
  udp_burst=${udp_burst:-40}
  if [[ -n "$srcip" ]]; then
    iptables -I INPUT -p udp -s "$srcip" --dport 7300 -m hashlimit --hashlimit-above "${max_udp}/second" --hashlimit-burst "$udp_burst" --hashlimit-mode srcip --hashlimit-name "udp_${user}" -j DROP
    rule_udp="udp-src:${srcip}-dport:7300-max:${max_udp}-burst:${udp_burst}"
  else
    iptables -I INPUT -p udp --dport 7300 -m hashlimit --hashlimit-above "${max_udp}/second" --hashlimit-burst "$udp_burst" --hashlimit-mode srcip --hashlimit-name "udp_${user}" -j DROP
    rule_udp="udp-all-dport:7300-max:${max_udp}-burst:${udp_burst}"
  fi
  echo "$user||$rule_udp" >> $LIMIT_FILE
  iptables-save >/etc/iptables.up.rules
fi
echo "‚úÖ UDP user $user created (exp: $exp)"
read -p "ENTER to continue..."
exec /usr/local/bin/menu
;;

# ----------------------------
# 4. Delete User
# ----------------------------
4)
clear
echo "‚ùå Delete User (UDP/SSH/Trojan)"
read -p "Username to delete: " user
sed -i "/^$user:/d" $UDPDIR/users.txt 2>/dev/null || true
sed -i "/^$user /d" /etc/trojan_users.txt 2>/dev/null || true
sed -i "/^$user /d" $EXPIRE_FILE 2>/dev/null
if id "$user" >/dev/null 2>&1; then userdel -r "$user" 2>/dev/null || true; fi

# Remove IP limits
if [ -f $LIMIT_FILE ]; then
  grep -F "^$user|" $LIMIT_FILE | while IFS='|' read -r u tcp_rule udp_rule; do
    [[ -n "$tcp_rule" ]] && iptables -D INPUT -p tcp -m connlimit --connlimit-above ${tcp_rule##*-max:} --connlimit-mask 32 -j REJECT 2>/dev/null || true
    [[ -n "$udp_rule" ]] && iptables -D INPUT -p udp -m hashlimit --hashlimit-name "udp_${user}" -j DROP 2>/dev/null || true
  done
  sed -i "/^$user|/d" $LIMIT_FILE 2>/dev/null
  iptables-save >/etc/iptables.up.rules
fi

echo "User $user and IP limits removed."
read -p "ENTER to continue..."
exec /usr/local/bin/menu
;;

# ----------------------------
# 5. List UDP Users
# ----------------------------
5)
clear
echo "üìã List of UDP Users"
cat $UDPDIR/users.txt
read -p "ENTER to continue..."
exec /usr/local/bin/menu
;;

# ----------------------------
# 6. Check Active UDP Sessions
# ----------------------------
6)
clear
echo "üîç Active UDP Sessions"
netstat -anu | grep 7300 || echo "No UDP session active"
read -p "ENTER to continue..."
exec /usr/local/bin/menu
;;

# ----------------------------
# 7. Restart All Services
# ----------------------------
7)
systemctl restart udp-custom
echo "‚úÖ All services restarted."
read -p "ENTER to continue..."
exec /usr/local/bin/menu
;;

# ----------------------------
# 8. Change Ports (UDP/WS)
# ----------------------------
8)
clear
echo "‚öôÔ∏è Change Ports (Not implemented)"
read -p "ENTER to continue..."
exec /usr/local/bin/menu
;;

# ----------------------------
# 9. VPS Speedtest
# ----------------------------
9)
clear
speedtest-cli
read -p "ENTER to continue..."
exec /usr/local/bin/menu
;;

# ----------------------------
# 10. Backup / Restore Users
# ----------------------------
10)
clear
echo "‚ö†Ô∏è Backup / Restore not yet implemented"
read -p "ENTER to continue..."
exec /usr/local/bin/menu
;;

# ----------------------------
# 11. System Info
# ----------------------------
11)
clear
neofetch
read -p "ENTER to continue..."
exec /usr/local/bin/menu
;;

# ----------------------------
# 12. Exit
# ----------------------------
12)
exit
;;

# ----------------------------
# 13. Set IP Limit Manual
# ----------------------------
13)
clear
read -p "Username: " user
read -p "Source IP (leave empty = all IPs): " srcip
read -p "Max TCP conn for WS/Trojan (leave empty to skip): " max_tcp
read -p "Max UDP packets/sec (leave empty to skip): " max_udp
read -p "UDP burst (default 40): " udp_burst
udp_burst=${udp_burst:-40}

if [[ -n "$max_tcp" ]]; then
  if [[ -n "$srcip" ]]; then
    iptables -I INPUT -p tcp -s "$srcip" --dport 443 -m connlimit --connlimit-above "$max_tcp" --connlimit-mask 32 -j REJECT --reject-with tcp-reset
    iptables -I INPUT -p tcp -s "$srcip" --dport 80 -m connlimit --connlimit-above "$max_tcp" --connlimit-mask 32 -j
